---
# ============================================================================
# PLAYBOOK PÃ‰DAGOGIQUE : IMPORT_TASKS vs INCLUDE_TASKS
# ============================================================================
#
# Ce playbook dÃ©montre les diffÃ©rences critiques entre import_tasks et include_tasks
# avec des exemples concrets d'Ã‰CHECS pour chaque mÃ©thode.
#
# DIFFÃ‰RENCE FONDAMENTALE :
# -------------------------
# â€¢ import_tasks  : STATIQUE - Ã©valuÃ© au PARSE TIME (avant l'exÃ©cution)
# â€¢ include_tasks : DYNAMIQUE - Ã©valuÃ© au RUN TIME (pendant l'exÃ©cution)
#
# ============================================================================

- name: "ğŸ”´ EXEMPLE 1 : Ã‰CHEC avec import_tasks (variables dynamiques)"
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: "ğŸ“ DÃ©finir une variable dynamiquement pendant l'exÃ©cution"
      ansible.builtin.set_fact:
        fichier_a_charger: "exemple_fichier.yml"
      
    # âŒ CECI VA Ã‰CHOUER avec import_tasks
    # Raison : import_tasks est Ã©valuÃ© AVANT l'exÃ©cution, donc la variable 
    # 'fichier_a_charger' n'existe pas encore au moment du parsing
    - name: "ğŸš« Ã‰CHEC : import_tasks avec variable dynamique"
      ansible.builtin.import_tasks: "{{ fichier_a_charger }}"
      # Erreur attendue : "The error appears to be in '...': line X, column Y, 
      # but may be elsewhere in the file depending on the exact syntax problem.
      # The variable 'fichier_a_charger' is undefined"
      ignore_errors: yes
      tags:
        - demo_import_fail

    - name: "âœ… Solution : utiliser include_tasks Ã  la place"
      ansible.builtin.debug:
        msg: "Pour des noms de fichiers dynamiques, utilisez include_tasks !"

---
- name: "âœ… EXEMPLE 2 : SUCCÃˆS avec include_tasks (variables dynamiques)"
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: "ğŸ“ DÃ©finir une variable dynamiquement"
      ansible.builtin.set_fact:
        environnement: "production"
      
    # âœ… CECI FONCTIONNE avec include_tasks
    # Raison : include_tasks est Ã©valuÃ© PENDANT l'exÃ©cution, donc la variable existe
    - name: "âœ… SUCCÃˆS : include_tasks avec variable dynamique"
      ansible.builtin.include_tasks: "tasks_{{ environnement }}.yml"
      when: false  # DÃ©sactivÃ© pour Ã©viter l'erreur de fichier manquant
      tags:
        - demo_include_success

    - name: "ğŸ’¡ Explication"
      ansible.builtin.debug:
        msg: "include_tasks Ã©value la variable AU MOMENT de l'exÃ©cution"

---
- name: "ğŸ”´ EXEMPLE 3 : PROBLÃˆME avec include_tasks (tags invisibles)"
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: "ğŸ“‹ TÃ¢che avant l'include"
      ansible.builtin.debug:
        msg: "Cette tÃ¢che est visible avec --list-tasks"
      tags:
        - visible

    # âš ï¸ LIMITATION avec include_tasks
    # Les tags des tÃ¢ches Ã€ L'INTÃ‰RIEUR du fichier inclus ne sont PAS visibles
    # lors d'un 'ansible-playbook --list-tasks'
    - name: "âš ï¸ LIMITATION : include_tasks et visibilitÃ© des tags"
      ansible.builtin.include_tasks: tasks_avec_tags.yml
      tags:
        - mon_include
      when: false  # DÃ©sactivÃ© pour Ã©viter l'erreur de fichier manquant

    - name: "ğŸ’¡ Explication du problÃ¨me"
      ansible.builtin.debug:
        msg: |
          âš ï¸ Avec include_tasks, les tags des tÃ¢ches incluses ne sont PAS
          visibles avec --list-tasks ou --list-tags car l'inclusion se fait
          DYNAMIQUEMENT pendant l'exÃ©cution, pas au parsing.
      tags:
        - explication

---
- name: "âœ… EXEMPLE 4 : SUCCÃˆS avec import_tasks (tags visibles)"
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: "ğŸ“‹ TÃ¢che avant l'import"
      ansible.builtin.debug:
        msg: "Cette tÃ¢che est visible"
      tags:
        - visible

    # âœ… AVANTAGE avec import_tasks
    # Tous les tags des tÃ¢ches importÃ©es SONT visibles avec --list-tasks
    - name: "âœ… AVANTAGE : import_tasks et visibilitÃ© des tags"
      ansible.builtin.import_tasks: tasks_avec_tags.yml
      tags:
        - mon_import
      when: false  # La condition est Ã©valuÃ©e pour CHAQUE tÃ¢che importÃ©e

    - name: "ğŸ’¡ Explication de l'avantage"
      ansible.builtin.debug:
        msg: |
          âœ… Avec import_tasks, TOUTES les tÃ¢ches importÃ©es sont visibles
          avec --list-tasks car l'import se fait STATIQUEMENT au parsing.
      tags:
        - explication

---
- name: "ğŸ”´ EXEMPLE 5 : PROBLÃˆME avec import_tasks (conditions)"
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    installer_nginx: true
    installer_apache: false

  tasks:
    # âš ï¸ COMPORTEMENT INATTENDU avec import_tasks
    # La condition 'when' est COPIÃ‰E sur CHAQUE tÃ¢che du fichier importÃ©
    # et non Ã©valuÃ©e globalement pour tout l'import
    - name: "âš ï¸ COMPORTEMENT : import_tasks avec when"
      ansible.builtin.import_tasks: installer_webserver.yml
      when: installer_nginx
      # La condition sera Ã©valuÃ©e pour CHAQUE tÃ¢che dans installer_webserver.yml
      # Pas une Ã©valuation globale "importer ou ne pas importer"

    - name: "ğŸ’¡ Explication"
      ansible.builtin.debug:
        msg: |
          Avec import_tasks, le 'when' est COPIÃ‰ sur chaque tÃ¢che importÃ©e.
          Ce n'est pas une dÃ©cision "importer ou ne pas importer",
          mais "appliquer la condition Ã  chaque tÃ¢che".

---
- name: "âœ… EXEMPLE 6 : SUCCÃˆS avec include_tasks (conditions)"
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    installer_apache: false

  tasks:
    # âœ… COMPORTEMENT ATTENDU avec include_tasks
    # La condition 'when' est Ã©valuÃ©e GLOBALEMENT : 
    # si false, le fichier n'est mÃªme pas chargÃ©
    - name: "âœ… COMPORTEMENT : include_tasks avec when"
      ansible.builtin.include_tasks: installer_webserver.yml
      when: installer_apache
      # Si la condition est false, le fichier n'est PAS du tout inclus

    - name: "ğŸ’¡ Explication"
      ansible.builtin.debug:
        msg: |
          Avec include_tasks, le 'when' est Ã©valuÃ© GLOBALEMENT.
          Si false, le fichier entier est ignorÃ© (pas chargÃ© du tout).

---
- name: "ğŸ“ EXEMPLE 7 : DÃ©monstration avec boucles"
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    # âŒ IMPOSSIBLE avec import_tasks
    # On ne peut PAS utiliser de boucle avec import_tasks
    # car c'est statique - impossible de savoir combien de fois importer
    - name: "ğŸš« IMPOSSIBLE : import_tasks avec loop"
      ansible.builtin.debug:
        msg: "import_tasks ne supporte PAS les boucles (loop/with_items)"

    # âœ… POSSIBLE avec include_tasks
    # On peut boucler sur include_tasks car c'est dynamique
    - name: "âœ… POSSIBLE : include_tasks avec loop"
      ansible.builtin.include_tasks: configurer_user.yml
      loop:
        - alice
        - bob
        - charlie
      loop_control:
        loop_var: username
      when: false  # DÃ©sactivÃ© pour Ã©viter l'erreur de fichier manquant

# ============================================================================
# TABLEAU RÃ‰CAPITULATIF : QUAND UTILISER QUOI ?
# ============================================================================
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ CRITÃˆRE                     â”‚ import_tasks     â”‚ include_tasks    â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Moment d'Ã©valuation         â”‚ Parse time       â”‚ Run time         â”‚
# â”‚                             â”‚ (statique)       â”‚ (dynamique)      â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Variables dynamiques        â”‚ âŒ Non supportÃ©  â”‚ âœ… SupportÃ©      â”‚
# â”‚ dans le nom de fichier      â”‚                  â”‚                  â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ VisibilitÃ© avec             â”‚ âœ… Visible       â”‚ âŒ Non visible   â”‚
# â”‚ --list-tasks/--list-tags    â”‚                  â”‚                  â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Comportement avec 'when'    â”‚ âš ï¸ CopiÃ© sur     â”‚ âœ… Ã‰valuation    â”‚
# â”‚                             â”‚ chaque tÃ¢che     â”‚ globale          â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Support des boucles         â”‚ âŒ Non supportÃ©  â”‚ âœ… SupportÃ©      â”‚
# â”‚ (loop/with_items)           â”‚                  â”‚                  â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Performance                 â”‚ âœ… Meilleure     â”‚ âš ï¸ LÃ©gÃ¨rement    â”‚
# â”‚                             â”‚ (pas de surcoÃ»t) â”‚ plus lent        â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Tags des tÃ¢ches incluses    â”‚ âœ… HÃ©ritÃ©s       â”‚ âš ï¸ Non hÃ©ritÃ©s   â”‚
# â”‚                             â”‚                  â”‚                  â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Cas d'usage recommandÃ©      â”‚ Fichiers fixes   â”‚ Fichiers         â”‚
# â”‚                             â”‚ RÃ©utilisation    â”‚ dynamiques       â”‚
# â”‚                             â”‚ simple           â”‚ Boucles          â”‚
# â”‚                             â”‚                  â”‚ Conditions       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ============================================================================
# RÃˆGLE D'OR POUR VOS Ã‰LÃˆVES
# ============================================================================
#
# ğŸ¯ UTILISEZ import_tasks SI :
#    â€¢ Le nom du fichier est fixe (pas de variable)
#    â€¢ Vous voulez voir les tags avec --list-tasks
#    â€¢ Vous voulez les meilleures performances
#    â€¢ Vous avez besoin de la validation statique
#
# ğŸ¯ UTILISEZ include_tasks SI :
#    â€¢ Le nom du fichier contient une variable (dynamique)
#    â€¢ Vous utilisez une boucle (loop/with_items)
#    â€¢ Vous voulez une condition "tout ou rien" avec when
#    â€¢ Vous chargez conditionnellement des tÃ¢ches complexes
#
# ============================================================================
# EXERCICES POUR L'Ã‰LÃˆVE
# ============================================================================
#
# EXERCICE 1 : CrÃ©ez tasks_production.yml et tasks_development.yml
#              Chargez-les dynamiquement avec include_tasks selon une variable
#              Essayez avec import_tasks et observez l'Ã©chec
#
# EXERCICE 2 : CrÃ©ez un fichier de tÃ¢ches avec plusieurs tags
#              Comparez la sortie de --list-tags avec import_tasks vs include_tasks
#
# EXERCICE 3 : CrÃ©ez une boucle qui charge des tÃ¢ches pour plusieurs utilisateurs
#              Pourquoi import_tasks ne peut pas Ãªtre utilisÃ© ici ?
#
# EXERCICE 4 : Ajoutez une condition 'when: false' sur import_tasks et include_tasks
#              Observez la diffÃ©rence de comportement
#
# ============================================================================

